{% load static %}
<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gestión de Usuarios - Clínica Bosque Verde</title>
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
    <style>
        .contenedor-admin { max-width: 1200px; margin: 20px auto; padding: 0 16px; }
        .fila { display: grid; grid-template-columns: 2fr 1fr; gap: 24px; }
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 10px 12px; border-bottom: 1px solid #e0e0e0; text-align: left; }
        th { background: #f6f6f6; }
        .acciones { display: flex; gap: 8px; align-items: center; flex-wrap: wrap; }
        .acciones a, .acciones form { display: inline-block; margin: 0; }
        .acciones form { background: transparent; padding: 0; box-shadow: none; max-width: none; }
        .acciones button { width: auto; }
        .btn { padding: 8px 12px; border-radius: 4px; text-decoration: none; cursor: pointer; }
        .btn-primario { background: #2e7d32; color: #fff; }
        .btn-secundario { background: #1565c0; color: #fff; }
        .btn-peligro { background: #c62828; color: #fff; }
        .panel { background: #fff; border: 1px solid #e0e0e0; border-radius: 6px; padding: 16px; }
        .panel form { max-width: 100%; margin: 0; }
        .panel h3 { margin-top: 0; }
        .campo { margin-bottom: 10px; }
        .campo label { display: block; font-weight: 600; margin-bottom: 4px; }
        .campo input, .campo select { width: 100%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; }
        .buscador { margin: 12px 0 16px; }
        .mensaje { padding: 10px; background: #fff3cd; border: 1px solid #ffeeba; border-radius: 4px; margin-bottom: 10px; }
        .tabla-scroll { width: 100%; overflow-x: auto; -webkit-overflow-scrolling: touch; }
        .tabla-scroll table { min-width: 640px; }

        /* Responsivo */
        @media (max-width: 992px) {
            .fila { grid-template-columns: 1fr; }
            .tabla-scroll table { min-width: 560px; }
        }
        @media (max-width: 576px) {
            .contenedor-admin { padding: 0 10px; }
            th, td { padding: 8px; }
            .btn { padding: 6px 10px; font-size: 0.92rem; }
            .acciones { gap: 6px; }
            .tabla-scroll table { min-width: 520px; }
        }
        @media (max-width: 400px) {
            .btn { padding: 6px 8px; font-size: 0.88rem; }
            .acciones { gap: 6px; }
            .tabla-scroll table { min-width: 460px; }
        }
    </style>
    <script>
        function confirmarEliminacion(usuarioId, username) {
            if (confirm(`Eliminar usuario "${username}"?`)) {
                const form = document.getElementById(`form-eliminar-${usuarioId}`);
                form.submit();
            }
        }
    </script>
</head>
<body>
    <nav>
        <div class="logo-container">
            <img src="{% static 'assets/images/logo.jpeg' %}" alt="Logo Clínica Bosque Verde" class="logo">
            <a href="/" class="brand-name">Clínica Bosque Verde</a>
        </div>
        <ul class="link-container">
            <li><a href="/">Inicio</a></li>
        </ul>
    </nav>

    <div class="contenedor-admin">
        <h2 class="section-title">Gestión de Usuarios</h2>

        <div class="fila">
            <div class="panel">
                <form class="buscador" method="get">
                    <input type="text" name="q" placeholder="Buscar por usuario o nombre" value="{{ request.GET.q }}" />
                    <button class="btn btn-secundario" type="submit">Buscar</button>
                </form>
                <div class="tabla-scroll">
                    <table>
                        <thead>
                            <tr>
                                <th>Usuario</th>
                                <th>Nombre</th>
                                <th>Correo</th>
                                <th>Rol</th>
                                <th>Acciones</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for u in usuarios %}
                            <tr>
                                <td>{{ u.obj.username }}</td>
                                <td>{{ u.obj.first_name }} {{ u.obj.last_name }}</td>
                                <td>{{ u.obj.email }}</td>
                                <td>{{ u.rol }}</td>
                                <td class="acciones">
                                    <a class="btn btn-secundario" href="{% url 'editar_usuario' u.obj.id %}">Editar</a>
                                    <form id="form-eliminar-{{ u.obj.id }}" action="{% url 'eliminar_usuario' u.obj.id %}" method="post" style="display:inline;">
                                        {% csrf_token %}
                                        <button class="btn btn-peligro" type="button" onclick="confirmarEliminacion({{ u.obj.id }}, '{{ u.obj.username|escapejs }}')">Eliminar</button>
                                    </form>
                                </td>
                            </tr>
                            {% empty %}
                            <tr><td colspan="5">No hay usuarios.</td></tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="panel">
                {% if modo == 'editar' %}
                    <h3>Editar Usuario: {{ usuario_editar.username }}</h3>
                    <form method="post">
                        {% csrf_token %}
                        <div class="campo">
                            <label for="id_username">Usuario</label>
                            {{ form.username }}
                        </div>
                        <div class="campo">
                            <label for="id_first_name">Nombre</label>
                            {{ form.first_name }}
                        </div>
                        <div class="campo">
                            <label for="id_last_name">Apellido</label>
                            {{ form.last_name }}
                        </div>
                        <div class="campo">
                            <label for="id_email">Correo</label>
                            {{ form.email }}
                        </div>
                        <div class="campo">
                            <label for="id_password">Contraseña (dejar en blanco para no cambiar)</label>
                            {{ form.password }}
                        </div>
                        <div class="campo">
                            <label for="id_rol">Rol</label>
                            {{ form.rol }}
                        </div>
                        <button class="btn btn-primario" type="submit">Guardar Cambios</button>
                        <a class="btn" href="{% url 'gestion_usuarios' %}">Cancelar</a>
                    </form>
                {% else %}
                    <h3>Crear Usuario</h3>
                    <form method="post">
                        {% csrf_token %}
                        <div class="campo">
                            <label for="id_username">Usuario</label>
                            {{ form.username }}
                        </div>
                        <div class="campo">
                            <label for="id_first_name">Nombre</label>
                            {{ form.first_name }}
                        </div>
                        <div class="campo">
                            <label for="id_last_name">Apellido</label>
                            {{ form.last_name }}
                        </div>
                        <div class="campo">
                            <label for="id_email">Correo</label>
                            {{ form.email }}
                        </div>
                        <div class="campo">
                            <label for="id_password">Contraseña</label>
                            {{ form.password }}
                        </div>
                        <div class="campo">
                            <label for="id_rol">Rol</label>
                            {{ form.rol }}
                        </div>
                        <button class="btn btn-primario" type="submit">Crear</button>
                    </form>
                {% endif %}
            </div>
        </div>
    </div>

    <footer>
        <p>&copy; 2025 Clínica Bosque Verde</p>
    </footer>
    <script src="{% static 'js/menu.js' %}"></script>
</body>
</html>

